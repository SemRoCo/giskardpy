name: CI standalone
defaults:
  run:
    shell: bash -ieo pipefail {0}
on:
  push:
    branches:
      - ros1-noetic-main
  pull_request:
#    branches:
#      - master
#      - devel
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'info'
        type: choice
        options:
          - info
          - warning
          - debug
      tags:
        description: 'Test scenario tags'
        required: false
        type: boolean
      is_trigger:
        description: 'Is trigger from giskardpy'
        required: true
        type: boolean
        default: false
        hidden: true
      pr_id:
        description: 'ID of PR from giskardpy'
        required: false
        type: string
        hidden: true
jobs:
  docker:
      name: Docker Check and Build
      runs-on: ubuntu-latest

      permissions:
        contents: read
        packages: write

      steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

        # ghcr.io link needs to be lowercase, as such the following echo to $GITHUB_ENV
      - name: create Image Name
        run: |
          echo "IMAGE_NAME=ghcr.io/${OWNER,,}/$(echo ${{ github.repository }} | cut -d'/' -f2)" >> $GITHUB_ENV
        env:
          OWNER: '${{ github.repository_owner }}'

      - name: Inspect Docker image manifest and check dependencies
        id: check_repos
        run: |
          BPB_CHANGED=false
          QPSWIFT_CHANGED=false
          
          for dockerfilepath in $(find . -name 'Dockerfile' | rev | cut -d'/' -f2- | rev); do
            ROS_DISTRO=$(grep -oP '(?<=FROM osrf/ros:)[a-z]+' "$dockerfilepath"/Dockerfile)
            
            # Extract specific labels if needed
            QPSWIFT_DOCKER=$(docker manifest inspect -v ${IMAGE_NAME}:${ROS_DISTRO} | jq -r '.[0].OCIManifest.annotations.QPSWIFT // empty')
            BPB_DOCKER=$(docker manifest inspect -v ${IMAGE_NAME}:${ROS_DISTRO} | jq -r '.[0].OCIManifest.annotations.BPB // empty')
            
            # Get the latest commit SHA for QPSWIFT
            LATEST_SHA_QPSWIFT=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/SemRoCo/qpswift/commits/main | jq -r '.sha')
  
            # Compare and set output
            if [ "$LATEST_SHA_QPSWIFT" != "$QPSWIFT_DOCKER" ]; then
              QPSWIFT_CHANGED=true
              echo "QPSwift in ${IMAGE_NAME}:${ROS_DISTRO} has changed: $LATEST_SHA_QPSWIFT from: $QPSWIFT_DOCKER"
            fi
            
            # Get the latest commit SHA for BPB
            LATEST_SHA_BPB=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/SemRoCo/bullet3/commits/master | jq -r '.sha')
  
            # Compare and set output
            if [ "$LATEST_SHA_BPB" != "$BPB_DOCKER" ]; then
              BPB_CHANGED=true
              echo "BetterPyBullet in ${IMAGE_NAME}:${ROS_DISTRO} has changed: $LATEST_SHA_BPB from: $BPB_DOCKER"
            fi
          done
          
          if [[ "$BPB_CHANGED" == "true" || "$BPB_CHANGED" == "true" ]]; then
            echo "NEEDS_REBUILD=true" >> $GITHUB_OUTPUT
            echo "Rebuild needed due to changes in dependencies"
          else
            echo "NEEDS_REBUILD=false" >> $GITHUB_OUTPUT
            echo "No changes detected in dependencies"
          fi

      - name: Check for Dockerfile changes
        id: check_changes
        run: |
          DOCKERFILE_CHANGED=false

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # For manual triggers, nver build Docker images
            echo "Manual workflow trigger, will not build Docker images"
            DOCKERFILE_CHANGED=false

          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # For PRs, check if any Dockerfiles changed in the PR
            echo "Checking for Dockerfile changes in PR"
          
            # Fetch the PR head for PRs from forks
            git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-${{ github.event.pull_request.number }}
            
            # Compare base to PR head
            if git diff --name-only origin/${{ github.event.pull_request.base.ref }} pr-${{ github.event.pull_request.number }} | grep -q "Dockerfile"; then
              echo "Dockerfile changes detected in PR"
              DOCKERFILE_CHANGED=true
            fi

          elif [[ "${{ github.event_name }}" == "push" ]]; then
            # For pushes, check if any Dockerfiles changed in the push
            echo "Checking for Dockerfile changes in push"
            if git diff --name-only HEAD^ HEAD | grep -q "Dockerfile"; then
              echo "Dockerfile changes detected in push"
              DOCKERFILE_CHANGED=true
            fi
          fi

          echo "changed=${DOCKERFILE_CHANGED}" >> $GITHUB_OUTPUT
          echo "Dockerfile changed: ${DOCKERFILE_CHANGED}"

      - name: Set up Docker Buildx
        if: steps.check_changes.outputs.changed == 'true' || steps.check_repos.outputs.NEEDS_REBUILD == 'true'
        uses: docker/setup-buildx-action@v3

      # Setup Download-URL for requirements.txt for python dependencies
      - name: Set Download URL
        if: steps.check_changes.outputs.changed == 'true' || steps.check_repos.outputs.NEEDS_REBUILD == 'true'
        run: | 
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # For PR events, use the specific SHA of the HEAD commit in the PR
            echo "DOWNLOAD_URL=https://raw.githubusercontent.com/${{ github.repository }}/${{ github.event.pull_request.head.sha }}/requirements.txt" >> $GITHUB_ENV
          else
            # For push events, use the branch/tag name
            echo "DOWNLOAD_URL=https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/requirements.txt" >> $GITHUB_ENV
          fi

      # Builds docker images and uploads them to the GitHub Container Registry
      - name: Find Dockerfiles and Build Images
        if: steps.check_changes.outputs.changed == 'true' || steps.check_repos.outputs.NEEDS_REBUILD == 'true'
        run: |
          # Get Commit Hash for Dependencies
          SHA_QPSWIFT=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/SemRoCo/qpswift/commits/main | jq -r '.sha')
          SHA_BPB=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/SemRoCo/bullet3/commits/master | jq -r '.sha')
          
          for dockerfilepath in $(find . -name 'Dockerfile' | rev | cut -d'/' -f2- | rev); do
            ROS_DISTRO=$(grep -oP '(?<=FROM osrf/ros:)[a-z]+' "$dockerfilepath"/Dockerfile)

            if [ -z "$ROS_DISTRO" ]; then
              echo "No Ubuntu version found in $dockerfile, skipping..."
              continue
            fi
            
            docker buildx build \
              --platform linux/amd64 \
              --build-arg DOWNLOAD_URL=${DOWNLOAD_URL} \
              --annotation "manifest:QPSWIFT=${SHA_QPSWIFT}" \
              --annotation "manifest:BPB=${SHA_BPB}" \
              -t ${IMAGE_NAME}:${ROS_DISTRO} \
              --push \
              $dockerfilepath
            
          done
  hsr:
    needs: docker
    uses: ./.github/workflows/reusable_robot_ci.yml
    with:
      robot: hsr
      test1: test_integration_hsr.py::TestJointGoals
      test2: test_integration_hsr.py::TestCollisionAvoidanceGoals
      test3: test_integration_hsr.py::TestConstraints
      is_trigger: ${{ inputs.is_trigger || false }} # Default values don't seem to work correctly, using this instead
      pr_id: ${{ inputs.pr_id || null }}
  donbot:
    needs: docker
    uses: ./.github/workflows/reusable_robot_ci.yml
    with:
      robot: donbot
      test1: test_integration_donbot.py::TestCartGoals
      test2: test_integration_donbot.py::TestConstraints
      test3: test_integration_donbot.py::TestJointGoals
      is_trigger: ${{ inputs.is_trigger || false }}
      pr_id: ${{ inputs.pr_id || null }}
  pr2_part1:
    needs: docker
    uses: ./.github/workflows/reusable_robot_ci.yml
    with:
      robot: pr2
      test1: test_integration_pr2.py::TestConstraints
      test2: test_integration_pr2.py::TestCartGoals
      test3: test_integration_pr2.py::TestManipulability::test_manip1
      test4: test_integration_pr2.py::TestWeightScaling
      test5: test_integration_pr2.py::TestFeatureFunctions
      test6: test_integration_pr2.py::TestEndMotionReason
      is_trigger: ${{ inputs.is_trigger || false }}
      pr_id: ${{ inputs.pr_id || null }}
  pr2_part2:
    needs: docker
    uses: ./.github/workflows/reusable_robot_ci.yml
    with:
      robot: pr2
      test1: test_integration_pr2.py::TestCollisionAvoidanceGoals
      test2: test_integration_pr2.py::TestWorldManipulation
      test3: test_integration_pr2.py::TestSelfCollisionAvoidance
      test4: test_integration_pr2.py::TestInfoServices
      test5: test_integration_pr2.py::TestJointGoals
      test6: test_integration_pr2.py::TestMonitors
      is_trigger: ${{ inputs.is_trigger || false }}
      pr_id: ${{ inputs.pr_id || null }}
  tiago:
    needs: docker
    uses: ./.github/workflows/reusable_robot_ci.yml
    with:
      robot: tiago
      test1: test_integration_tiago_stand_alone.py::TestConstraints
      test2: test_integration_tiago_stand_alone.py::TestJointGoals
      test3: test_integration_tiago_stand_alone.py::TestCollisionAvoidance
      test4: test_integration_tiago_stand_alone.py::TestCartGoals
      is_trigger: ${{ inputs.is_trigger || false }}
      pr_id: ${{ inputs.pr_id || null }}
