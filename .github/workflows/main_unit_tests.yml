name: CI unit tests
defaults:
  run:
    shell: bash -ieo pipefail {0}
on:
  push:
    branches:
      - master
      - devel
  pull_request:
#    branches:
#      - master
#      - devel
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'info'
        type: choice
        options:
        - info
        - warning
        - debug
      tags:
        description: 'Test scenario tags'
        required: false
        type: boolean
jobs:
  build_dependencies:
    uses: ./.github/workflows/build_dependencies.yml
  build:
    needs: [ build_dependencies ]
    strategy:
      matrix:
        tests: [ "test_cas_wrapper", "test_symbol_manager", "test_math", "test_giskard_library"]
        ubuntu_version: [ "ubuntu-20.04", "ubuntu-24.04"]
    runs-on: ${{ matrix.ubuntu_version }}
    env:
      QP_SOLVER: ${{ matrix.qp_solver }}
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          path: 'giskardpy'
      #load cache ------------------------------------------------------------------------------------------------------
      - name: load pip cache
        id: pip-load
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip
      - name: load qpSWIFT
        id: load-qpSWIFT
        uses: actions/cache@v4
        with:
          path: ~/qpSWIFT
          key: qpSWIFT
      - name: install qpSWIFT python wrapper
        run: |
          sudo pip3 install numpy
          cd ~/qpSWIFT/python
          sudo python3 setup.py install
      - name: load bpb # -----------------------------------------------------------------------------------------------
        id: load-bpb
        uses: actions/cache@v4
        with:
          path: ~/bpb
          key: bpb
      - name: add bpb to bashrc
        run: |
          cd ~/bpb/bullet3
          echo 'export PYTHONPATH=${PYTHONPATH}':"${PWD}/build_cmake/better_python:${PWD}/examples/pybullet" >> ~/.bashrc
      - name: install pip dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -r giskardpy/requirements.txt
      - name: test
        run: |
          cd giskardpy
          python3 -m pytest -s test/${{ matrix.tests }}.py
  #    - name: Setup upterm session
  ##      if: always()
  #      if: failure()
  #      uses: lhotari/action-upterm@v1
